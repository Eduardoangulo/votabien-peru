# # .github/workflows/cleanup-dockerhub.yml
# name: Cleanup Docker Hub Images

# on:
#   # Se ejecuta despuÃ©s de cada deploy exitoso
#   # workflow_run:
#   #   workflows: ["Deploy Frontend"]
#   #   types:
#   #     - completed
  
#   # TambiÃ©n puedes ejecutarlo manualmente
#   workflow_dispatch:
  
#   # O programarlo semanalmente
#   schedule:
#     - cron: '0 2 * * 0'  # Cada domingo a las 2 AM

# jobs:
#   cleanup:
#     runs-on: ubuntu-latest
#     if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Docker Hub login
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       - name: Delete old images (keep last 10 versions)
#         env:
#           DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
#           DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
#           IMAGE_NAME: votabien_frontend
#           KEEP_LAST: 3
#         run: |
#           echo "ðŸ§¹ Starting cleanup for ${IMAGE_NAME}..."
          
#           # Obtener token de autenticaciÃ³n
#           TOKEN=$(curl -s -H "Content-Type: application/json" \
#             -X POST \
#             -d "{\"username\": \"${DOCKERHUB_USERNAME}\", \"password\": \"${DOCKERHUB_TOKEN}\"}" \
#             https://hub.docker.com/v2/users/login/ | jq -r .token)
          
#           if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
#             echo "âŒ Failed to authenticate with Docker Hub"
#             exit 1
#           fi
          
#           echo "âœ… Authenticated successfully"
          
#           # Obtener todas las tags (excluyendo 'latest')
#           TAGS=$(curl -s -H "Authorization: JWT ${TOKEN}" \
#             "https://hub.docker.com/v2/repositories/${DOCKERHUB_USERNAME}/${IMAGE_NAME}/tags/?page_size=100" \
#             | jq -r '.results[] | select(.name != "latest") | .name' \
#             | sort -V -r)
          
#           if [ -z "$TAGS" ]; then
#             echo "âš ï¸ No tags found to clean up"
#             exit 0
#           fi
          
#           TOTAL_TAGS=$(echo "$TAGS" | wc -l)
#           echo "ðŸ“Š Found ${TOTAL_TAGS} tags (excluding 'latest')"
          
#           # Mantener solo las Ãºltimas N versiones
#           TAGS_TO_DELETE=$(echo "$TAGS" | tail -n +$((KEEP_LAST + 1)))
          
#           if [ -z "$TAGS_TO_DELETE" ]; then
#             echo "âœ… Nothing to delete, keeping last ${KEEP_LAST} versions"
#             exit 0
#           fi
          
#           DELETE_COUNT=$(echo "$TAGS_TO_DELETE" | wc -l)
#           echo "ðŸ—‘ï¸  Will delete ${DELETE_COUNT} old tags..."
          
#           # Eliminar tags antiguas
#           echo "$TAGS_TO_DELETE" | while read -r tag; do
#             echo "  Deleting: ${tag}"
#             curl -s -X DELETE \
#               -H "Authorization: JWT ${TOKEN}" \
#               "https://hub.docker.com/v2/repositories/${DOCKERHUB_USERNAME}/${IMAGE_NAME}/tags/${tag}/"
            
#             # Verificar si se eliminÃ³ correctamente
#             if [ $? -eq 0 ]; then
#               echo "    âœ… Deleted successfully"
#             else
#               echo "    âŒ Failed to delete"
#             fi
#           done
          
#           echo ""
#           echo "ðŸŽ‰ Cleanup completed!"
#           echo "ðŸ“ˆ Kept: ${KEEP_LAST} most recent versions"
#           echo "ðŸ—‘ï¸  Deleted: ${DELETE_COUNT} old versions"

#       - name: Summary
#         run: |
#           echo "### ðŸ§¹ Docker Hub Cleanup Summary" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "- **Repository:** votabien_frontend" >> $GITHUB_STEP_SUMMARY
#           echo "- **Retention policy:** Keep last 10 versions" >> $GITHUB_STEP_SUMMARY
#           echo "- **Status:** âœ… Completed" >> $GITHUB_STEP_SUMMARY